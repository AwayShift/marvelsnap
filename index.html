<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[TUG] Tortuga Snap</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üê¢</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Exo 2', sans-serif;
            background-color: #0D1117;
            color: #E6EDF3;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            margin: 0;
            scrollbar-color: #30363D #0D1117;
            scrollbar-width: thin;
        }
        h2, h3 {
            color: #f0b90b;
            font-weight: 700;
            text-align: center;
        }
        #app-wrapper {
            width: 100%;
            max-width: 800px;
        }
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }
        .modal-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            width: 90%;
            max-width: 600px;
            background-color: #161B22;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #30363D;
        }
        .close-modal-button {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 2.5em;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
        }
        .close-modal-button:hover {
            color: white;
        }
        #countdown-container {
            color: #E6EDF3;
            padding: 10px 20px;
            margin-bottom: 20px;
            font-size: 1.1em;
            text-align: center;
            box-sizing: border-box;
        }
        #countdownTimer {
            color: #00E5FF;
            font-weight: 700;
        }
        #toggle-management-container {
            margin-bottom: 10px;
            text-align: left;
            display: flex;
            align-items: center;
        }
        #management-wrapper, #result-container {
            box-sizing: border-box;
        }
        #main-action-container, #actions {
             background-color: #161B22;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #30363D;
        }
        #result-container {
            background-color: #161B22;
            padding: 25px;
            border-radius: 8px;
            border: 1px solid #30363D;
        }
        textarea, select, input[type="password"] {
            width: 100%;
            box-sizing: border-box;
            min-height: 45px;
            background-color: #0D1117;
            color: #E6EDF3;
            border: 1px solid #30363D;
            border-radius: 6px;
            padding: 10px;
            font-family: 'Exo 2', sans-serif;
            font-size: 14px;
            margin-bottom: 15px;
        }
        textarea {
             min-height: 150px;
        }
        button {
            padding: 12px 20px;
            background: linear-gradient(90deg, #007BFF, #00BFFF);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            display: block;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s ease, background-color 0.3s;
        }
        button:hover {
            transform: scale(1.02);
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        #toggleManagementButton, #adminLoginButton, #showRankingButton {
            background: #161B22;
            border: 1px solid #30363D;
            width: 45px;
            height: 45px;
            border-radius: 8px;
            font-size: 24px;
            padding: 8px;
            margin: 0;
            color: #d1d1cf;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        #adminLoginButton, #showRankingButton {
            margin-left: 10px;
        }
        #saveButton {
            background: linear-gradient(90deg, #28a745, #20c997);
        }
        #showHistoryModalButton {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.8em;
            padding: 0;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 990;
        }
        #historyModal button {
            font-size: 14px;
            padding: 8px 12px;
        }
        #viewCurrentButton {
            background: linear-gradient(90deg, #56ab2f, #a8e063);
        }
        #editDateButton {
            background: linear-gradient(90deg, #ffc107, #ff9800);
        }
        #deleteWeekButton {
            background: linear-gradient(90deg, #ff7e5f, #feb47b);
        }
        #clearHistoryButton {
            background: linear-gradient(90deg, #dc3545, #fd7e14);
        }
        #toggleColumnButton {
            background: none;
            border: 1px solid #00E5FF;
            color: #00E5FF;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            padding: 0;
            margin: 0 0 0 10px;
            font-size: 16px;
            line-height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
            min-width: 28px;
        }
        .help-icon {
            margin-left: 4px;
            cursor: help;
            vertical-align: middle;
            display: inline-flex;
            align-items: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-spacing: 0;
        }
        th, td {
            padding: 16px 12px;
            text-align: left;
            border-bottom: 1px solid #21262D;
        }
        th {
            color: #00E5FF;
            font-weight: 700;
            text-align: right;
            white-space: nowrap;
        }
        th:first-child {
            text-align: left;
        }
        td.player-name {
            font-weight: 700;
            cursor: pointer;
            transition: color 0.2s;
        }
        td.player-name:hover {
            color: #f0b90b;
        }
        td.numeric-data {
            color: #00E5FF;
            text-align: right;
            font-weight: 700;
            text-shadow: 0 0 5px rgba(0, 229, 255, 0.4);
        }
        .toggle-cell {
            cursor: pointer;
            user-select: none;
        }
        td.positive-diff {
            color: #28a745;
            text-shadow: 0 0 8px rgba(40, 167, 69, 0.7);
        }
        td.negative-diff {
            color: #dc3545;
            text-shadow: 0 0 8px rgba(220, 53, 69, 0.7);
        }
        tr.special-player > td {
            background-color: #0d2f3f;
        }
        th:nth-child(4),
        td:nth-child(4) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        tr.is-high-scorer td:first-child {
            border-left: 2px solid #f0b90b;
        }
        tr.is-high-scorer td:last-child {
            border-right: 2px solid #f0b90b;
        }
        tr.first-high-scorer > td {
            border-top: 2px solid #f0b90b;
        }
        tr.last-high-scorer > td {
            border-bottom: 2px solid #f0b90b;
        }
        #toggleExample {
            display: block;
            text-align: center;
            color: #f0b90b;
            text-decoration: none;
            font-size: 0.9em;
            margin-top: -10px;
            margin-bottom: 15px;
        }
        #toggleExample:hover {
            text-decoration: underline;
        }
        #formatExample {
            background-color: #0D1117;
            border: 1px solid #30363D;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        #formatExample p {
            margin-top: 0;
            margin-bottom: 8px;
            text-align: center;
        }
        #formatExample code {
            display: block;
            background-color: #010409;
            padding: 8px;
            border-radius: 4px;
            color: #E6EDF3;
            text-align: center;
            word-break: break-all;
        }
        
        /* --- ESTILOS DO CALEND√ÅRIO --- */
        #calendar-container {
            margin-top: 20px;
            user-select: none;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        #month-year-display {
            font-size: 1.2em;
            font-weight: 700;
            color: #f0b90b;
        }
        .nav-btn {
            background: none;
            border: 1px solid #30363D;
            color: #E6EDF3;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            line-height: 1;
            margin: 0;
            padding: 0;
        }
        .nav-btn:hover {
            background-color: #30363D;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        .calendar-day, .calendar-day-header {
            text-align: center;
            padding: 10px 5px;
        }
        .calendar-day-header {
            font-weight: bold;
            color: #00E5FF;
            font-size: 0.9em;
        }
        .calendar-day {
            border-radius: 4px;
            color: #aaa;
        }
        .day-in-month {
             color: #E6EDF3;
        }
        .day-has-data {
            background-color: #0d2f3f;
            border: 1px solid #00E5FF;
            font-weight: bold;
            cursor: pointer;
            position: relative;
        }
        .day-has-data:hover {
            background-color: #00E5FF;
            color: #0D1117;
        }
         .day-has-data::after {
            content: '';
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: #f0b90b;
        }
        .day-selected {
            background-color: #f0b90b !important;
            color: #0D1117 !important;
            font-weight: bold;
        }

        /* --- ESTILOS DO HIST√ìRICO INDIVIDUAL E RANKING GERAL --- */
        #playerHistoryModal, #rankingModal {
            flex-direction: column;
            max-height: 85vh;
        }
        #playerHistoryTitle, #rankingModal h3 {
            margin-bottom: 10px;
        }
        #playerHistoryFilters, #rankingFilters {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            flex-shrink: 0;
        }
        .filter-btn {
            width: auto;
            display: inline-block;
            margin: 0;
            padding: 8px 16px;
            background: #161B22;
            border: 1px solid #30363D;
        }
        .filter-btn.active {
            background: #007BFF;
            border-color: #007BFF;
        }
        #playerHistoryContent, #rankingContent {
            overflow-y: auto;
            flex-grow: 1;
        }
        #playerHistoryModal table th,
        #playerHistoryModal table td,
        #rankingModal table th,
        #rankingModal table td {
            padding: 10px 12px;
            font-size: 0.9em;
        }
        #playerHistoryPagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            flex-shrink: 0;
        }
        #playerHistoryPagination button {
            width: 100px;
            margin: 0;
        }
        .rank-top-3 td {
            background-color: #2c2a13 !important;
            color: #f0b90b !important;
            font-weight: bold;
        }
        .rank-bottom-3 td {
            background-color: #3d191d !important;
            color: #ff8e8e !important;
        }
        .inactive-player td {
            opacity: 0.6;
            font-style: italic;
        }
        .inactive-player td:nth-child(2)::after {
            content: '(inativo)';
            font-size: 0.8em;
            margin-left: 8px;
            color: #aaa;
        }

        /* --- ESTILO DA BARRA DE ROLAGEM --- */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0D1117;
        }
        ::-webkit-scrollbar-thumb {
            background: #30363D;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }


        @media screen and (max-width: 768px) {
            body { padding: 10px; }
            #main-action-container, #result-container, #actions {
                width: 100%;
                padding: 15px;
            }
            #toggleColumnButton { display: none; }
            table { border: 0; }
            table thead { display: none; }
            table tr {
                display: block;
                margin-bottom: 15px;
                border: none;
                border-radius: 6px;
                overflow: hidden;
            }
            tr.is-high-scorer {
                border: 2px solid #f0b90b;
            }
            tr.special-player {
                border: 2px solid #0d2f3f;
            }
            table td {
                display: block;
                text-align: right;
                padding-left: 50%;
                position: relative;
                border-bottom: 1px dotted #21262D;
                background-color: transparent !important;
            }
            tr.special-player > td {
                 background-color: #0d2f3f !important;
            }
            tr td[data-label="Total"] {
                background-color: rgba(255, 255, 255, 0.05) !important;
            }
            table td:last-child { border-bottom: 0; }
            table td::before {
                content: attr(data-label);
                position: absolute;
                left: 12px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
                color: #f0b90b;
            }
            td.player-name {
                background-color: rgba(0, 229, 255, 0.1) !important;
                text-align: center;
                padding-left: 12px;
                font-size: 1.2em;
                border-bottom: 1px solid #30363D;
            }
            td.player-name::before { display: none; }
            td.numeric-data { font-size: 1.1em; }
            .toggle-cell { cursor: default; }
            .positive-diff::before { color: #28a745 !important; }
            .negative-diff::before { color: #dc3545 !important; }
        }
    </style>
</head>
<body>
    
    <div id="app-wrapper">
        <div id="countdown-container">
            Pr√≥ximo reset em: <span id="countdownTimer">Calculando...</span>
        </div>

    <div id="toggle-management-container">
        <button id="toggleManagementButton" title="Gerenciar Tabela">‚ò∞</button>
        <button id="showRankingButton" title="Ranking Geral">üèÜ</button>
        <button id="adminLoginButton" title="Login de Administrador">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
        </button>
    </div>

        <div id="management-wrapper" style="display: none;">
            <div id="main-action-container">
                <button id="showInputModalButton">Inserir / Atualizar Dados da Semana</button>
            </div>
            <div id="actions">
                <p>Ap√≥s gerar uma nova tabela, salve-a no hist√≥rico online para o futuro.</p>
                <button id="saveButton" disabled>Adicionar Semana ao Hist√≥rico</button>
            </div>
        </div>

        <div id="result-container">
            <h2 id="resultTitle">Tabela de Resultados</h2>
            <div id="tableOutput">
                <p>Carregando dados mais recentes...</p>
            </div>
        </div>
    </div>
    
    <button id="showHistoryModalButton" class="fab" title="Ver Hist√≥rico de Semanas">üìÖ</button>

    <div id="inputModalOverlay" class="modal-overlay"></div>
    <div id="controls" class="modal-container">
        <span id="closeInputModalButton" class="close-modal-button">&times;</span>
        <h3>Inserir Dados das Imagens</h3>
        
        <a href="#" id="toggleExample">Ver exemplo de formato</a>
        <div id="formatExample" style="display: none;">
            <p>O texto deve seguir o padr√£o NOME PONTOS PONTOS TOTAL, separado por espa√ßos.</p>
            <code>‚òÖ PlayerExemplo1 3000 500 3500 PlayerExemplo2 2500 450 2950</code>
        </div>

        <p style="text-align: center; margin-bottom: 20px;">
            N√£o tem o texto? Use um site de OCR para extrair:
            <br>
            <a href="https://www.i2ocr.com/free-online-portuguese-ocr" target="_blank" rel="noopener noreferrer" style="color: #f0b90b; font-weight: bold;">
                Acessar i2OCR (Portugu√™s)
            </a>
        </p>
        <textarea id="textInput1" placeholder="Texto da Imagem 1..."></textarea>
        <textarea id="textInput2" placeholder="Texto da Imagem 2 (opcional)..."></textarea>
        <button id="processButton">Gerar Tabela Comparativa</button>
    </div>
    
    <div id="historyModalOverlay" class="modal-overlay"></div>
    <div id="historyModal" class="modal-container">
        <span id="closeHistoryModalButton" class="close-modal-button">&times;</span>
        <h2>Hist√≥rico de Semanas</h2>
        <p>Selecione uma data no calend√°rio para visualizar ou gerenciar.</p>
        
        <div id="calendar-container"></div>
        
        <div id="history-actions" style="margin-top: 20px;">
            <button id="editDateButton" disabled>Editar Data Selecionada</button>
            <button id="deleteWeekButton" disabled>Excluir Semana Selecionada</button>
            <hr style="border-color: #30363D; margin: 20px 0;">
            <button id="viewCurrentButton" disabled>Voltar √† Semana Atual</button>
            <button id="clearHistoryButton" disabled>Limpar Todo o Hist√≥rico</button>
        </div>
    </div>

    <div id="adminModalOverlay" class="modal-overlay"></div>
    <div id="adminModal" class="modal-container">
        <span id="closeAdminModalButton" class="close-modal-button">&times;</span>
        <h3>Login de Administrador</h3>
        <input type="password" id="adminPasswordInput" placeholder="Digite a senha...">
        <button id="submitAdminPasswordButton">Entrar</button>
    </div>

    <div id="playerHistoryModalOverlay" class="modal-overlay"></div>
    <div id="playerHistoryModal" class="modal-container">
        <span id="closePlayerHistoryModalButton" class="close-modal-button">&times;</span>
        <h3 id="playerHistoryTitle">Hist√≥rico do Jogador</h3>
        <div id="playerHistoryFilters">
            <button class="filter-btn" data-weeks="3">√öltimas 3</button>
            <button class="filter-btn" data-weeks="5">√öltimas 5</button>
            <button class="filter-btn" data-weeks="10">√öltimas 10</button>
            <button class="filter-btn active" data-weeks="all">Todas</button>
        </div>
        <div id="playerHistoryContent"></div>
        <div id="playerHistoryPagination"></div>
    </div>

    <div id="rankingModalOverlay" class="modal-overlay"></div>
    <div id="rankingModal" class="modal-container">
        <span id="closeRankingModalButton" class="close-modal-button">&times;</span>
        <h3>Ranking Geral</h3>
        <div id="rankingFilters">
            <button class="filter-btn active" data-filter="current">Membros Atuais</button>
            <button class="filter-btn" data-filter="all">Todos os Membros</button>
        </div>
        <div id="rankingContent"></div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
document.addEventListener('DOMContentLoaded', async () => {
    
    // --- CONFIGURA√á√ïES E INICIALIZA√á√ÉO ---
    const config = {
        firebase: {
            apiKey: "AIzaSyAxFwYdzni3SVOerZAO-ELRyDGFSoRGlLU",
            authDomain: "marvelsnap-e6bb0.firebaseapp.com",
            projectId: "marvelsnap-e6bb0",
            storageBucket: "marvelsnap-e6bb0.appspot.com",
            messagingSenderId: "679376113892",
            appId: "1:679376113892:web:b71a52627e05d7ef961cf1",
            measurementId: "G-NW3DNL02VW"
        },
        highlight: {
            highScoreThreshold: 3500,
            specialPlayers: ['Awayshift', 'MeganosPkz']
        },
        resetTime: {
            day: 2, // Ter√ßa-feira (0=Domingo, 1=Segunda, ...)
            hour: 16
        }
    };

    const icons = {
        lock: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`,
        unlock: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>`,
        help: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z"/></svg>`
    };

    firebase.initializeApp(config.firebase);
    const db = firebase.firestore();
    const historyDocRef = db.collection("clanData").doc("history");
    const adminDocRef = db.collection("admin").doc("config");

    const elements = {
        showInputModalButton: document.getElementById('showInputModalButton'),
        inputModalOverlay: document.getElementById('inputModalOverlay'),
        controlsModal: document.getElementById('controls'),
        closeInputModalButton: document.getElementById('closeInputModalButton'),
        showHistoryModalButton: document.getElementById('showHistoryModalButton'),
        historyModalOverlay: document.getElementById('historyModalOverlay'),
        historyModal: document.getElementById('historyModal'),
        closeHistoryModalButton: document.getElementById('closeHistoryModalButton'),
        processButton: document.getElementById('processButton'),
        saveButton: document.getElementById('saveButton'),
        textInput1: document.getElementById('textInput1'),
        textInput2: document.getElementById('textInput2'),
        tableOutputDiv: document.getElementById('tableOutput'),
        resultTitle: document.getElementById('resultTitle'),
        countdownTimer: document.getElementById('countdownTimer'),
        calendarContainer: document.getElementById('calendar-container'),
        editDateButton: document.getElementById('editDateButton'),
        deleteWeekButton: document.getElementById('deleteWeekButton'),
        viewCurrentButton: document.getElementById('viewCurrentButton'),
        clearHistoryButton: document.getElementById('clearHistoryButton'),
        toggleManagementButton: document.getElementById('toggleManagementButton'),
        managementWrapper: document.getElementById('management-wrapper'),
        adminLoginButton: document.getElementById('adminLoginButton'),
        adminModalOverlay: document.getElementById('adminModalOverlay'),
        adminModal: document.getElementById('adminModal'),
        closeAdminModalButton: document.getElementById('closeAdminModalButton'),
        adminPasswordInput: document.getElementById('adminPasswordInput'),
        submitAdminPasswordButton: document.getElementById('submitAdminPasswordButton'),
        toggleExample: document.getElementById('toggleExample'),
        formatExample: document.getElementById('formatExample'),
        playerHistoryModalOverlay: document.getElementById('playerHistoryModalOverlay'),
        playerHistoryModal: document.getElementById('playerHistoryModal'),
        closePlayerHistoryModalButton: document.getElementById('closePlayerHistoryModalButton'),
        playerHistoryTitle: document.getElementById('playerHistoryTitle'),
        playerHistoryFilters: document.getElementById('playerHistoryFilters'),
        playerHistoryContent: document.getElementById('playerHistoryContent'),
        playerHistoryPagination: document.getElementById('playerHistoryPagination'),
        showRankingButton: document.getElementById('showRankingButton'),
        rankingModalOverlay: document.getElementById('rankingModalOverlay'),
        rankingModal: document.getElementById('rankingModal'),
        closeRankingModalButton: document.getElementById('closeRankingModalButton'),
        rankingFilters: document.getElementById('rankingFilters'),
        rankingContent: document.getElementById('rankingContent')
    };
    
    let currentPlayersData = [];
    let showingDifference = true;
    let isManagementVisible = false;
    let isAdmin = false;
    let calendarState = {
        currentDate: new Date(),
        selectedWeekIndex: null
    };

    // --- MODAIS E CONTROLES DE UI ---
    function openModal(modal, overlay) { overlay.style.display = 'block'; modal.style.display = 'block'; }
    function closeModal(modal, overlay) { overlay.style.display = 'none'; modal.style.display = 'none'; }
    
    elements.showInputModalButton.addEventListener('click', () => openModal(elements.controlsModal, elements.inputModalOverlay));
    elements.closeInputModalButton.addEventListener('click', () => closeModal(elements.controlsModal, elements.inputModalOverlay));
    elements.inputModalOverlay.addEventListener('click', () => closeModal(elements.controlsModal, elements.inputModalOverlay));

    elements.showHistoryModalButton.addEventListener('click', async () => {
        openModal(elements.historyModal, elements.historyModalOverlay);
        await populateHistoryCalendar();
    });
    elements.closeHistoryModalButton.addEventListener('click', () => closeModal(elements.historyModal, elements.historyModalOverlay));
    elements.historyModalOverlay.addEventListener('click', () => closeModal(elements.historyModal, elements.historyModalOverlay));
    
    elements.closeAdminModalButton.addEventListener('click', () => closeModal(elements.adminModal, elements.adminModalOverlay));
    elements.adminModalOverlay.addEventListener('click', () => closeModal(elements.adminModal, elements.adminModalOverlay));

    elements.closePlayerHistoryModalButton.addEventListener('click', () => closeModal(elements.playerHistoryModal, elements.playerHistoryModalOverlay));
    elements.playerHistoryModalOverlay.addEventListener('click', () => closeModal(elements.playerHistoryModal, elements.playerHistoryModalOverlay));

    elements.showRankingButton.addEventListener('click', () => showGeneralRanking());
    elements.closeRankingModalButton.addEventListener('click', () => closeModal(elements.rankingModal, elements.rankingModalOverlay));
    elements.rankingModalOverlay.addEventListener('click', () => closeModal(elements.rankingModal, elements.rankingModalOverlay));


    elements.toggleManagementButton.addEventListener('click', (e) => {
        isManagementVisible = !isManagementVisible;
        elements.managementWrapper.style.display = isManagementVisible ? 'block' : 'none';
        e.currentTarget.title = isManagementVisible ? 'Ocultar Gerenciamento' : 'Gerenciar Tabela';
    });

    elements.toggleExample.addEventListener('click', (e) => {
        e.preventDefault();
        const exampleDiv = elements.formatExample;
        const isVisible = exampleDiv.style.display === 'block';
        exampleDiv.style.display = isVisible ? 'none' : 'block';
        e.target.textContent = isVisible ? 'Ver exemplo de formato' : 'Ocultar exemplo';
    });

    // --- L√ìGICA DE ADMIN ---
    function setAdmin(status) {
        isAdmin = status;
        elements.saveButton.disabled = !isAdmin || currentPlayersData.length === 0;
        elements.clearHistoryButton.disabled = !isAdmin;
        if (calendarState.selectedWeekIndex === null) {
            elements.editDateButton.disabled = true;
            elements.deleteWeekButton.disabled = true;
        } else {
            elements.editDateButton.disabled = !isAdmin;
            elements.deleteWeekButton.disabled = !isAdmin;
        }
        if (isAdmin) {
            elements.adminLoginButton.innerHTML = icons.unlock;
            elements.adminLoginButton.title = 'Sair do modo Administrador';
        } else {
            elements.adminLoginButton.innerHTML = icons.lock;
            elements.adminLoginButton.title = 'Login de Administrador';
        }
    }

    elements.adminLoginButton.addEventListener('click', () => {
        if (isAdmin) {
            setAdmin(false);
            alert('Voc√™ saiu do modo administrador.');
        } else {
            openModal(elements.adminModal, elements.adminModalOverlay);
        }
    });

    elements.submitAdminPasswordButton.addEventListener('click', async () => {
        const password = elements.adminPasswordInput.value;
        if (!password) return alert('Por favor, digite a senha.');
        try {
            const doc = await adminDocRef.get();
            if (doc.exists && doc.data().password === password) {
                setAdmin(true);
                alert('Login de administrador realizado com sucesso!');
                closeModal(elements.adminModal, elements.adminModalOverlay);
                elements.adminPasswordInput.value = '';
            } else {
                alert('Senha incorreta.');
            }
        } catch (error) {
            console.error("Erro ao verificar senha: ", error);
            alert('N√£o foi poss√≠vel verificar a senha.');
        }
    });

    // --- L√ìGICA PRINCIPAL DE DADOS ---
    elements.processButton.addEventListener('click', async () => {
        showingDifference = true;
        const combinedText = elements.textInput1.value + '\n' + elements.textInput2.value;
        if (combinedText.trim() === '') return alert('Por favor, cole o texto de pelo menos uma imagem.');
        
        const history = await getHistory();
        const previousData = history.weeks.length > 0 ? history.weeks[history.weeks.length - 1].data : [];
        const parsedPlayers = parseOcrText(combinedText);

        if (parsedPlayers.length === 0) {
            alert('O formato do texto parece incorreto. Nenhum jogador foi encontrado. Verifique o exemplo abaixo.');
            elements.formatExample.style.display = 'block';
            elements.toggleExample.textContent = 'Ocultar exemplo';
            return;
        }

        currentPlayersData = comparePlayerData(parsedPlayers, previousData);
        
        renderTable(currentPlayersData, { isHistoric: false });
        elements.resultTitle.textContent = 'Tabela de Resultados (Comparativa)';
        if (isAdmin) {
            elements.saveButton.disabled = false;
        }
        elements.viewCurrentButton.disabled = false;
        closeModal(elements.controlsModal, elements.inputModalOverlay);
    });
    
    elements.saveButton.addEventListener('click', async () => {
        if (!isAdmin) return alert('Apenas administradores podem salvar dados.');
        if (currentPlayersData.length === 0) return alert('N√£o h√° dados para salvar.');
        if (confirm('Deseja salvar os dados no hist√≥rico online para todo o cl√£?')) {
            const history = await getHistory();
            const today = new Date().toLocaleDateString('pt-br', {day: '2-digit', month: '2-digit', year: 'numeric'});
            history.weeks.push({ date: today, data: currentPlayersData });
            try {
                await historyDocRef.set(history);
                alert(`Dados da semana de ${today} salvos com sucesso!`);
            } catch (error) { console.error("Erro ao salvar: ", error); alert("Ocorreu um erro ao salvar."); }
        }
    });

    elements.tableOutputDiv.addEventListener('click', async (event) => {
        const toggleTrigger = event.target.closest('.toggle-cell');
        if (toggleTrigger && currentPlayersData.length > 0) {
            showingDifference = !showingDifference;
            renderTable(currentPlayersData, { isHistoric: false, showDiff: showingDifference });
            return;
        }
        
        const playerCell = event.target.closest('.player-name');
        if (playerCell) {
            const playerName = playerCell.textContent.trim();
            if (playerName && playerName.length > 0) {
                await handlePlayerHistoryClick(playerName);
            }
        }
    });

    // --- L√ìGICA DO HIST√ìRICO E CALEND√ÅRIO ---
    async function populateHistoryCalendar() {
        const history = await getHistory();
        const hasHistory = history.weeks.length > 0;

        elements.clearHistoryButton.disabled = !isAdmin || !hasHistory;
        
        const markedDates = history.weeks.map(week => ({
            dateStr: week.date,
            index: history.weeks.indexOf(week)
        }));

        renderCalendar(calendarState.currentDate.getFullYear(), calendarState.currentDate.getMonth(), markedDates);
    }

    function renderCalendar(year, month, markedDates) {
        const container = elements.calendarContainer;
        const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
        
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        let html = `
            <div class="calendar-header">
                <button class="nav-btn" id="prev-month-btn">&lt;</button>
                <span id="month-year-display">${monthNames[month]} ${year}</span>
                <button class="nav-btn" id="next-month-btn">&gt;</button>
            </div>
            <div class="calendar-grid">
        `;
        
        dayNames.forEach(day => {
            html += `<div class="calendar-day-header">${day}</div>`;
        });

        for (let i = 0; i < firstDay; i++) {
            html += `<div class="calendar-day"></div>`;
        }

        for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${String(day).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}/${year}`;
            const markedDate = markedDates.find(d => d.dateStr === dateStr);
            let classes = "calendar-day day-in-month";
            let dataAttr = "";

            if (markedDate) {
                classes += " day-has-data";
                dataAttr = `data-week-index="${markedDate.index}"`;
            }
            if (markedDate && markedDate.index === calendarState.selectedWeekIndex) {
                 classes += " day-selected";
            }

            html += `<div class="${classes}" ${dataAttr}>${day}</div>`;
        }
        
        html += `</div></div>`;
        container.innerHTML = html;
        
        document.getElementById('prev-month-btn').addEventListener('click', () => {
            calendarState.currentDate.setMonth(calendarState.currentDate.getMonth() - 1);
            populateHistoryCalendar();
        });
        
        document.getElementById('next-month-btn').addEventListener('click', () => {
            calendarState.currentDate.setMonth(calendarState.currentDate.getMonth() + 1);
            populateHistoryCalendar();
        });

        container.querySelectorAll('.day-has-data').forEach(dayCell => {
            dayCell.addEventListener('click', async (e) => {
                const selectedIndex = parseInt(e.currentTarget.dataset.weekIndex);
                calendarState.selectedWeekIndex = selectedIndex;

                const history = await getHistory();
                const selectedWeek = history.weeks[selectedIndex];
                
                renderTable(selectedWeek.data, { isHistoric: true });
                elements.resultTitle.textContent = `Visualizando Semana de ${selectedWeek.date}`;
                
                if (isAdmin) {
                    elements.editDateButton.disabled = false;
                    elements.deleteWeekButton.disabled = false;
                }
                
                populateHistoryCalendar();
                closeModal(elements.historyModal, elements.historyModalOverlay);
            });
        });
    }

    elements.editDateButton.addEventListener('click', async () => {
        if (!isAdmin) return alert('Apenas administradores podem editar a data.');
        const selectedIndex = calendarState.selectedWeekIndex;
        if (selectedIndex === null) return alert("Nenhuma semana selecionada.");

        const history = await getHistory();
        const currentWeek = history.weeks[selectedIndex];
        const newDate = prompt(`Digite a nova data para a semana de "${currentWeek.date}" (DD/MM/AAAA):`, currentWeek.date);
        
        if (newDate === null || newDate.trim() === '') return;
        if (!/^\d{2}\/\d{2}\/\d{4}$/.test(newDate)) return alert("Formato de data inv√°lido. Use DD/MM/AAAA.");
        
        history.weeks[selectedIndex].date = newDate;
        try {
            await historyDocRef.set(history);
            alert("Data atualizada com sucesso!");
            await populateHistoryCalendar();
        } catch (error) { console.error("Erro ao editar data: ", error); alert("Ocorreu um erro."); }
    });

    elements.deleteWeekButton.addEventListener('click', async () => {
        if (!isAdmin) return alert('Apenas administradores podem excluir semanas.');
        const selectedIndex = calendarState.selectedWeekIndex;
        if (selectedIndex === null) return alert("Nenhuma semana selecionada.");

        const history = await getHistory();
        const weekToDelete = history.weeks[selectedIndex];
        
        if (confirm(`Tem certeza que deseja EXCLUIR a semana de ${weekToDelete.date}?`)) {
            history.weeks.splice(selectedIndex, 1);
            try {
                await historyDocRef.set(history);
                alert("Semana exclu√≠da com sucesso.");
                calendarState.selectedWeekIndex = null;
                elements.editDateButton.disabled = true;
                elements.deleteWeekButton.disabled = true;
                await populateHistoryCalendar();
                await loadLatestComparison();
            } catch (error) { console.error("Erro ao excluir semana: ", error); alert("Ocorreu um erro."); }
        }
    });

    elements.viewCurrentButton.addEventListener('click', () => {
        showingDifference = true;
        if (currentPlayersData.length === 0) return alert('Nenhuma tabela da semana atual foi carregada ou gerada.');
        const isComparative = currentPlayersData[0] && currentPlayersData[0].hasOwnProperty('previousTotal');
        renderTable(currentPlayersData, { isHistoric: !isComparative });
        elements.resultTitle.textContent = 'An√°lise da Semana Mais Recente';
        closeModal(elements.historyModal, elements.historyModalOverlay);
    });

    elements.clearHistoryButton.addEventListener('click', async () => {
        if (!isAdmin) return alert('Apenas administradores podem limpar o hist√≥rico.');
        if (confirm('Tem certeza que deseja apagar TODO o hist√≥rico online?')) {
            try {
                await historyDocRef.set({ weeks: [] });
                alert('Hist√≥rico online apagado.');
                calendarState.selectedWeekIndex = null;
                elements.editDateButton.disabled = true;
                elements.deleteWeekButton.disabled = true;
                await populateHistoryCalendar();
                elements.tableOutputDiv.innerHTML = '<p>Hist√≥rico limpo. Gere uma nova tabela para come√ßar.</p>';
                elements.resultTitle.textContent = 'Tabela de Resultados';
            } catch (error) { console.error("Erro ao limpar hist√≥rico: ", error); alert("Ocorreu um erro."); }
        }
    });

    // --- L√ìGICA DO HIST√ìRICO INDIVIDUAL E PAGINA√á√ÉO ---
    async function handlePlayerHistoryClick(playerName) {
        const history = await getHistory();
        if (!history || history.weeks.length === 0) {
            alert("Nenhum hist√≥rico encontrado para pesquisar.");
            return;
        }

        const playerData = getPlayerHistory(playerName, history.weeks);
        
        if (playerData.length === 0) {
            alert(`Nenhum registro encontrado para o jogador ${playerName}.`);
            return;
        }

        elements.playerHistoryTitle.textContent = `Hist√≥rico de: ${playerName}`;
        
        const newFilters = elements.playerHistoryFilters.cloneNode(true);
        elements.playerHistoryFilters.parentNode.replaceChild(newFilters, elements.playerHistoryFilters);
        elements.playerHistoryFilters = newFilters;
        
        elements.playerHistoryFilters.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => renderPlayerHistoryContent(playerData, btn.dataset.weeks, 1));
        });

        renderPlayerHistoryContent(playerData, 'all', 1);

        elements.playerHistoryModalOverlay.style.display = 'block';
        elements.playerHistoryModal.style.display = 'flex';
    }

    function getPlayerHistory(playerName, weeks) {
        const playerData = [];
        for (let i = weeks.length - 1; i >= 0; i--) {
            const week = weeks[i];
            const player = week.data.find(p => p.jogador === playerName);
            if (player) {
                playerData.push({ date: week.date, total: player.total });
            }
        }
        return playerData;
    }

    function renderPlayerHistoryContent(playerData, filter, page = 1) {
        const itemsPerPage = 10;
        let dataToDisplay;

        elements.playerHistoryPagination.innerHTML = '';

        if (filter !== 'all') {
            dataToDisplay = playerData.slice(0, parseInt(filter));
        } else {
            if (playerData.length > itemsPerPage) {
                const totalPages = Math.ceil(playerData.length / itemsPerPage);
                const start = (page - 1) * itemsPerPage;
                dataToDisplay = playerData.slice(start, start + itemsPerPage);

                const prevDisabled = page === 1 ? 'disabled' : '';
                const nextDisabled = page === totalPages ? 'disabled' : '';

                elements.playerHistoryPagination.innerHTML = `
                    <button id="player-hist-prev" ${prevDisabled}>Anterior</button>
                    <span>P√°gina ${page} de ${totalPages}</span>
                    <button id="player-hist-next" ${nextDisabled}>Pr√≥xima</button>
                `;

                document.getElementById('player-hist-prev')?.addEventListener('click', () => renderPlayerHistoryContent(playerData, 'all', page - 1));
                document.getElementById('player-hist-next')?.addEventListener('click', () => renderPlayerHistoryContent(playerData, 'all', page + 1));
            } else {
                dataToDisplay = playerData;
            }
        }

        if (dataToDisplay.length === 0) {
            elements.playerHistoryContent.innerHTML = "<p>Nenhum registro para este filtro.</p>";
            return;
        }

        let html = '<table><thead><tr><th>Data</th><th>Pontua√ß√£o</th><th>Varia√ß√£o</th></tr></thead><tbody>';
        
        for (let i = 0; i < dataToDisplay.length; i++) {
            const currentEntry = dataToDisplay[i];
            const originalIndex = playerData.findIndex(p => p.date === currentEntry.date && p.total === currentEntry.total);
            const previousEntry = playerData[originalIndex + 1];
            
            let diffHtml = '-';
            if (previousEntry) {
                const diff = currentEntry.total - previousEntry.total;
                const sign = diff > 0 ? '+' : '';
                const diffClass = diff > 0 ? 'positive-diff' : (diff < 0 ? 'negative-diff' : '');
                diffHtml = `<span class="${diffClass}">${sign}${diff}</span>`;
            }

            html += `
                <tr>
                    <td>${currentEntry.date}</td>
                    <td class="numeric-data">${currentEntry.total}</td>
                    <td class="numeric-data">${diffHtml}</td>
                </tr>
            `;
        }

        html += '</tbody></table>';
        elements.playerHistoryContent.innerHTML = html;

        elements.playerHistoryFilters.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.weeks === filter);
        });
    }

    // --- L√ìGICA DO RANKING GERAL ---
    async function showGeneralRanking() {
        const history = await getHistory();
        if (!history || history.weeks.length === 0) {
            alert("N√£o h√° hist√≥rico suficiente para gerar um ranking.");
            return;
        }

        const overallRanking = calculateOverallRank(history.weeks);
        const latestWeekData = history.weeks[history.weeks.length - 1].data;

        const newFilters = elements.rankingFilters.cloneNode(true);
        elements.rankingFilters.parentNode.replaceChild(newFilters, elements.rankingFilters);
        elements.rankingFilters = newFilters;

        elements.rankingFilters.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => renderRankingTable(overallRanking, latestWeekData, btn.dataset.filter));
        });

        renderRankingTable(overallRanking, latestWeekData, 'current');
        
        elements.rankingModalOverlay.style.display = 'block';
        elements.rankingModal.style.display = 'flex';
    }

    function calculateOverallRank(weeks) {
        const playerScores = new Map();
        weeks.forEach(week => {
            week.data.forEach(player => {
                const currentScore = playerScores.get(player.jogador) || 0;
                playerScores.set(player.jogador, currentScore + player.total);
            });
        });

        const rankedPlayers = Array.from(playerScores, ([jogador, totalScore]) => ({ jogador, totalScore }));
        rankedPlayers.sort((a, b) => b.totalScore - a.totalScore);
        
        return rankedPlayers;
    }

    function renderRankingTable(rankedData, latestWeekData, filterType) {
        let displayData;
        const currentMembers = new Set(latestWeekData.map(p => p.jogador));
        
        if (filterType === 'current') {
            displayData = rankedData.filter(p => currentMembers.has(p.jogador));
        } else {
            displayData = rankedData;
        }

        if (displayData.length === 0) {
            elements.rankingContent.innerHTML = "<p>Nenhum jogador para exibir neste filtro.</p>";
            return;
        }

        let html = '<table><thead><tr><th>#</th><th>Jogador</th><th>Pontua√ß√£o Total</th></tr></thead><tbody>';
        const totalToDisplay = displayData.length;

        displayData.forEach((player, index) => {
            let rankClass = '';
            if (index < 3) {
                rankClass = 'rank-top-3';
            } else if (index >= totalToDisplay - 3 && totalToDisplay > 3) {
                rankClass = 'rank-bottom-3';
            }

            if (filterType === 'all' && !currentMembers.has(player.jogador)) {
                rankClass += ' inactive-player';
            }

            html += `
                <tr class="${rankClass}">
                    <td>${index + 1}</td>
                    <td>${player.jogador}</td>
                    <td class="numeric-data">${player.totalScore.toLocaleString('pt-BR')}</td>
                </tr>
            `;
        });
        html += '</tbody></table>';

        elements.rankingContent.innerHTML = html;

        elements.rankingFilters.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.filter === filterType);
        });
    }


    // --- FUN√á√ïES AUXILIARES ---
    async function getHistory() {
        try {
            const doc = await historyDocRef.get();
            return doc.exists ? doc.data() : { weeks: [] };
        } catch (error) { console.error("Erro ao buscar hist√≥rico: ", error); return { weeks: [] }; }
    }
    
    function updateCountdown() {
        const now = new Date();
        const { day: targetDay, hour: targetHour } = config.resetTime;
        let nextResetDate = new Date();
        nextResetDate.setHours(targetHour, 0, 0, 0);
        const daysUntilNextTuesday = (targetDay - now.getDay() + 7) % 7;
        nextResetDate.setDate(now.getDate() + daysUntilNextTuesday);
        if (daysUntilNextTuesday === 0 && now.getTime() > nextResetDate.getTime()) {
            nextResetDate.setDate(nextResetDate.getDate() + 7);
        }
        const timeRemaining = nextResetDate.getTime() - now.getTime();
        const days = Math.floor(timeRemaining / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeRemaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
        elements.countdownTimer.textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
    }
    
    function comparePlayerData(currentData, previousData) {
        const previousDataMap = new Map(previousData.map(p => [p.jogador, p]));
        return currentData.map(player => {
            const newPlayer = { ...player };
            const previousPlayer = previousDataMap.get(newPlayer.jogador);
            if (previousPlayer) {
                newPlayer.difference = parseInt(newPlayer.total) - parseInt(previousPlayer.total);
                newPlayer.previousTotal = previousPlayer.total;
            } else {
                newPlayer.difference = 'Novo';
            }
            return newPlayer;
        });
    }

    function parseOcrText(ocrText) {
        const items = ocrText.replace(/[.,]/g, '').split(/\s+/).filter(item => item.trim() !== '');
        let players = [];
        let currentPlayer = { jogador: '', numbers: [] };
        for (const item of items) {
            if (isNaN(parseInt(item))) {
                if (currentPlayer.numbers.length > 0) {
                    currentPlayer = { jogador: ` ${item}`, numbers: [] };
                } else {
                    currentPlayer.jogador += ` ${item}`;
                }
            } else if (currentPlayer.jogador) {
                currentPlayer.numbers.push(item);
            }
            if (currentPlayer.jogador && currentPlayer.numbers.length === 3) {
                const rawName = currentPlayer.jogador.trim();
                const cleanedName = rawName.replace(/^[\s‚≠ê*‚òÖ]+/g, '');
                players.push({
                    jogador: cleanedName,
                    cubo: currentPlayer.numbers[0],
                    tarefas: currentPlayer.numbers[1],
                    total: parseInt(currentPlayer.numbers[2])
                });
                currentPlayer = { jogador: '', numbers: [] };
            }
        }
        const uniquePlayers = [];
        const seenPlayers = new Map();
        for (const player of players) {
            if (!seenPlayers.has(player.jogador)) {
                seenPlayers.set(player.jogador, true);
                uniquePlayers.push(player);
            }
        }
        return uniquePlayers;
    }

    function renderTable(data, options) {
        elements.tableOutputDiv.innerHTML = generateTableHTML(data, options);
    }
    
    function generateTableHTML(playersData, options = {}) {
        const { isHistoric = false, showDiff = true } = options;
        if (playersData.length === 0) return '<p>Nenhum dado de jogador v√°lido foi encontrado.</p>';
        
        const helpIcon = (title) => `<span class="help-icon" title="${title}">${icons.help}</span>`;
        playersData.sort((a, b) => (b.total || 0) - (a.total || 0));
        
        let lastHighScorerIndex = -1;
        for (let i = playersData.length - 1; i >= 0; i--) {
            if (playersData[i].total > config.highlight.highScoreThreshold) {
                lastHighScorerIndex = i;
                break;
            }
        }

        let lastColumnHeader = '';
        if (!isHistoric) {
            if (showDiff) {
                lastColumnHeader = `Diferen√ßa ${helpIcon("Diferen√ßa de pontos obtidos comparado a √∫ltima semana")}`;
            } else {
                lastColumnHeader = `Pont. Anterior ${helpIcon("Pontua√ß√£o feita na √∫ltima semana")}`;
            }
        }
        
        let html = '<table><thead><tr>';
        html += `<th>Jogador ${!isHistoric ? '<button id="toggleColumnButton" title="Alternar Visualiza√ß√£o">&#x21C6;</button>' : ''}</th>
                 <th>Cubos ${helpIcon("Pontua√ß√£o obtida por Cubos ganhos")}</th>
                 <th>Tarefas ${helpIcon("Pontua√ß√£o obtida por Tarefas realizadas")}</th>
                 <th>Total ${helpIcon("Pontua√ß√£o somada de pontos")}</th>`;

        if (!isHistoric) html += `<th>${lastColumnHeader}</th>`;
        html += '</tr></thead><tbody>';

        playersData.forEach((player, index) => {
            let rowClasses = '';
            if (player.total > config.highlight.highScoreThreshold) {
                rowClasses += ' is-high-scorer';
                if (index === 0) rowClasses += ' first-high-scorer';
                if (index === lastHighScorerIndex) rowClasses += ' last-high-scorer';
            }
            if (config.highlight.specialPlayers.includes(player.jogador)) {
                rowClasses += ' special-player';
            }

            html += `<tr class="${rowClasses.trim()}">
                        <td data-label="Jogador" class="player-name" title="Clique para exibir o hist√≥rico deste jogador">${player.jogador}</td>
                        <td data-label="Cubos" class="numeric-data">${player.cubo || 0}</td>
                        <td data-label="Tarefas" class="numeric-data">${player.tarefas || 0}</td>
                        <td data-label="Total" class="numeric-data">${player.total || 0}</td>`;
            
            if (!isHistoric) {
                let lastColumnHtml = '<td data-label="-" class="numeric-data">-</td>';
                if (showDiff) {
                    if (player.difference === 'Novo') {
                        lastColumnHtml = `<td data-label="Diferen√ßa" class="numeric-data toggle-cell" title="Clique para alternar">${player.difference}</td>`;
                    } else if (typeof player.difference === 'number') {
                        const sign = player.difference > 0 ? '+' : '';
                        const diffClass = player.difference > 0 ? 'positive-diff' : (player.difference < 0 ? 'negative-diff' : '');
                        lastColumnHtml = `<td data-label="Diferen√ßa" class="numeric-data toggle-cell ${diffClass}" title="Clique para alternar">${sign}${player.difference}</td>`;
                    }
                } else {
                    if (typeof player.previousTotal === 'number') {
                        lastColumnHtml = `<td data-label="Pont. Anterior" class="numeric-data toggle-cell" title="Clique para alternar">${player.previousTotal}</td>`;
                    } else {
                        lastColumnHtml = `<td data-label="Pont. Anterior" class="numeric-data toggle-cell" title="Clique para alternar">${player.difference === 'Novo' ? 'N/A' : '-'}</td>`;
                    }
                }
                html += lastColumnHtml;
            }
            html += '</tr>';
        });
        html += '</tbody></table>';
        return html;
    }

    async function initializePage() {
        updateCountdown();
        setInterval(updateCountdown, 1000);
        await loadLatestComparison();
        setAdmin(false);
    }
    
    async function loadLatestComparison() {
        showingDifference = true;
        const history = await getHistory();
        if (history.weeks.length === 0) {
            elements.tableOutputDiv.innerHTML = '<p>Nenhum hist√≥rico encontrado. Insira os dados da primeira semana para come√ßar.</p>';
            return;
        }
        let isComparative = false;
        if (history.weeks.length >= 2) {
            const latestWeekData = [...history.weeks[history.weeks.length - 1].data];
            const previousWeekData = history.weeks[history.weeks.length - 2].data;
            currentPlayersData = comparePlayerData(latestWeekData, previousWeekData);
            isComparative = true;
            elements.resultTitle.textContent = 'An√°lise da Semana Mais Recente';
        } else {
            currentPlayersData = history.weeks[0].data;
            elements.resultTitle.textContent = `Visualizando a √önica Semana Salva (${history.weeks[0].date})`;
        }
        renderTable(currentPlayersData, { isHistoric: !isComparative });
        elements.viewCurrentButton.disabled = false;
    }

    initializePage();
});
</script>

</body>
</html>
